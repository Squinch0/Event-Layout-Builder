<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sleeve Events • Official Room Planner</title>
  <style>
    /* =========================================================
       THEME
       ========================================================= */
    :root{
      --bg: #0b1020;
      --bg2:#050816;
      --panel:#0b1224;
      --panel2:#070d1b;
      --text:#e8edf7;
      --muted:#aab3c4;
      --border:rgba(255,255,255,.08);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 16px;
      --accent:#8b5cf6; /* purple */
      --accent2:#a855f7;
      --gold:#f5c86b;
      --pink:#ff4fa3;
      --blue:#40a2ff;
      --green:#22c55e;
      --ink:#0b1020;
      --grid: rgba(255,255,255,.07);
      --gridBold: rgba(255,255,255,.12);
      --btn:#0b1327;
      --btnHover:#101c39;
      --danger:#ff4d4d;
      --ok:#23c55e;

      --canvasBg:#050816;
      --roomStroke: rgba(255,255,255,.22);
      --select:#f5c86b;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --tap: 44px;
    }

    [data-theme="light"]{
      --bg:#f5f7fb;
      --bg2:#ffffff;
      --panel:#ffffff;
      --panel2:#ffffff;
      --text:#111827;
      --muted:#4b5563;
      --border:rgba(17,24,39,.12);
      --shadow: 0 16px 40px rgba(17,24,39,.12);
      --btn:#f2f4f8;
      --btnHover:#e9edf6;
      --canvasBg:#ffffff;
      --grid: rgba(17,24,39,.06);
      --gridBold: rgba(17,24,39,.10);
      --roomStroke: rgba(17,24,39,.25);
      --ink:#111827;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(139,92,246,.35), transparent 50%),
                  radial-gradient(900px 600px at 90% 0%, rgba(255,79,163,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      overflow:hidden;
    }

    /* =========================================================
       LAYOUT
       ========================================================= */
    .app{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      padding: 12px 12px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(0,0,0,.18), transparent);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }

    .brandBadge{
      width:38px;height:38px;
      border-radius:14px;
      display:grid;place-items:center;
      background: radial-gradient(90% 90% at 30% 10%, rgba(255,255,255,.18), transparent 50%),
                  linear-gradient(135deg, rgba(139,92,246,1), rgba(168,85,247,1));
      box-shadow: 0 10px 30px rgba(139,92,246,.25);
      flex:0 0 auto;
    }

    .brandBadge svg{ filter: drop-shadow(0 8px 10px rgba(0,0,0,.25)); }

    .brandTitle{ line-height:1.1; }
    .brandTitle .t1{ font-weight:900; letter-spacing:.08em; font-size:14px; }
    .brandTitle .t2{ font-size:12px; color:var(--muted); margin-top:3px; }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
    }

    .btn{
      height:36px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--btn);
      color: var(--text);
      padding: 0 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 10px 28px rgba(0,0,0,.15);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ background:var(--btnHover); }
    .btn.primary{
      border-color: rgba(139,92,246,.55);
      background: linear-gradient(135deg, rgba(76,29,149,1), rgba(139,92,246,1));
    }
    [data-theme="light"] .btn.primary{ color:#fff; }

    .btn.danger{ border-color: rgba(255,77,77,.35); color: #ffd5d5; }

    .pill{
      height:36px;
      padding:0 10px;
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(0,0,0,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    .switch{
      width:44px;height:24px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid var(--border);
      position:relative;
      flex:0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      top:3px;left:3px;
      width:18px;height:18px;
      border-radius:50%;
      background: linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.05));
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      transition: transform .18s ease;
    }
    .switch.on{ background: rgba(139,92,246,.25); border-color: rgba(139,92,246,.55); }
    .switch.on::after{ transform: translateX(20px); background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.45)); }

    .main{
      flex:1;
      display:flex;
      gap:12px;
      padding:12px;
      overflow:hidden;
    }

    .canvasCard{
      flex:1;
      min-width:0;
      border-radius:var(--radius);
      background: radial-gradient(1200px 700px at 20% 0%, rgba(139,92,246,.14), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(255,79,163,.10), transparent 55%),
                  linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.06));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .viewport{
      position:absolute;
      inset:0;
      overflow:hidden;
      touch-action: none; /* we manage gestures */
      background: var(--canvasBg);
    }

    .sidebar{
      width: 340px;
      flex:0 0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .panel{
      background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.05));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panelHeader{
      padding: 12px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--border);
    }
    .panelHeader .h{
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
      color: var(--muted);
    }

    .panelBody{ padding:12px; }

    .row{ display:flex; gap:10px; }
    .col{ flex:1; }

    label.small{ display:block; font-size:12px; color:var(--muted); font-weight:800; margin:0 0 6px; }
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid var(--border);
      background: rgba(0,0,0,.10);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 13px;
      outline:none;
    }
    textarea{ min-height: 78px; resize: vertical; }

    .muted{ color:var(--muted); }

    .palette{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }

    .tile{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,.10);
      padding: 10px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      min-height: 46px;
    }
    .tile:hover{ background: rgba(139,92,246,.12); border-color: rgba(139,92,246,.35); }
    .tile .name{ font-weight:900; font-size:12px; }
    .tile .note{ font-size:11px; color:var(--muted); font-weight:700; }

    .kbd{ font-family:var(--mono); font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid var(--border); background: rgba(0,0,0,.12); color:var(--muted); }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      height:34px;
      padding: 0 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.10);
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:12px;
      color:var(--text);
    }
    .chip:hover{ background: rgba(255,255,255,.06); }
    .chip.on{ border-color: rgba(139,92,246,.55); box-shadow: 0 12px 22px rgba(139,92,246,.12); }

    .swatch{ width:14px;height:14px; border-radius:5px; border:1px solid rgba(255,255,255,.25); }
    [data-theme="light"] .swatch{ border-color: rgba(17,24,39,.18); }

    .footerNote{
      font-size: 12px;
      line-height: 1.5;
      color: var(--muted);
    }

    .hide{ display:none !important; }

    /* =========================================================
       MOBILE
       ========================================================= */
    .fab{
      position:absolute;
      right:14px;
      bottom:14px;
      z-index:50;
      display:none;
      height:52px;
      padding:0 16px;
      border-radius: 999px;
      border:1px solid rgba(139,92,246,.55);
      background: linear-gradient(135deg, rgba(76,29,149,1), rgba(139,92,246,1));
      color:#fff;
      font-weight:900;
      letter-spacing:.02em;
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      cursor:pointer;
      align-items:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .sheetBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      z-index:70;
      display:none;
    }

    .sheet{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:80;
      background: linear-gradient(180deg, rgba(0,0,0,.2), rgba(0,0,0,.08));
      border-top:1px solid var(--border);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -24px 60px rgba(0,0,0,.35);
      max-height: 75vh;
      overflow:auto;
      display:none;
      padding: 12px;
    }
    .sheetHandle{ width:48px;height:4px; border-radius:99px; background: rgba(255,255,255,.20); margin: 6px auto 12px; }
    [data-theme="light"] .sheetHandle{ background: rgba(17,24,39,.18); }

    @media (max-width: 980px){
      .sidebar{ width: 300px; }
    }

    @media (max-width: 860px){
      body{ overflow:auto; }
      .app{ position:relative; height:auto; min-height:100vh; }
      .main{ flex-direction:column; overflow:visible; }
      .sidebar{ width:100%; }
      .canvasCard{ height: 64vh; }
    }

    @media (max-width: 560px){
      .brand{ min-width: 0; }
      .brandTitle .t2{ display:none; }
      .actions{ gap:6px; }
      .btn{ height: 34px; padding: 0 10px; font-size:12px; }
      .pill{ display:none; }
      .sidebar{ display:none; }
      .fab{ display:inline-flex; }
    }

    /* =========================================================
       EXPORT (print mode)
       ========================================================= */
    body.exporting .topbar,
    body.exporting .sidebar,
    body.exporting .fab,
    body.exporting .sheet,
    body.exporting .sheetBackdrop{
      display:none !important;
    }

    body.exporting .main{ padding:0; }
    body.exporting .canvasCard{ border-radius:0; border:none; box-shadow:none; }

    /* =========================================================
       CANVAS OBJECTS
       ========================================================= */
    .scene{
      position:absolute;
      left:0; top:0;
      width:100%; height:100%;
      overflow:hidden;
    }

    .stageLayer{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      transform-origin: 0 0;
    }

    .room{
      position:absolute;
      left:0; top:0;
      background:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 40px 40px;
      border: 2px solid var(--roomStroke);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }

    .room.gridBold{
      background:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px),
        linear-gradient(to right, var(--gridBold) 1px, transparent 1px),
        linear-gradient(to bottom, var(--gridBold) 1px, transparent 1px);
      background-size: 40px 40px, 40px 40px, 200px 200px, 200px 200px;
    }

    .bgImage{
      position:absolute;
      left:0; top:0;
      transform-origin: 0 0;
      will-change: transform;
      pointer-events:none;
      opacity: .9;
      filter: saturate(1.02) contrast(1.02);
    }

    .item{
      position:absolute;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 8px;
      text-align:center;
      font-weight:900;
      font-size: 12px;
      letter-spacing:.02em;
      user-select:none;
      cursor: grab;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      transform-origin:center center;
      touch-action:none;
    }

    [data-theme="light"] .item{
      border-color: rgba(17,24,39,.14);
      background: rgba(17,24,39,.04);
      box-shadow: 0 14px 32px rgba(17,24,39,.10);
    }

    .item.dragging{ cursor:grabbing; opacity:.95; }
    .item.selected{ outline: 2px solid var(--select); outline-offset: 2px; }
    .item.locked{ opacity: .60; cursor:default; border-style:dashed; }

    .handle{
      position:absolute;
      width: 12px; height: 12px;
      border-radius: 6px;
      background: rgba(245,200,107,1);
      border:1px solid rgba(0,0,0,.22);
      box-shadow: 0 12px 22px rgba(0,0,0,.25);
      z-index: 20;
      display:none;
      touch-action:none;
    }
    .item.selected .handle{ display:block; }

    .handle.br{ right:-6px; bottom:-6px; cursor:nwse-resize; }
    .handle.bl{ left:-6px; bottom:-6px; cursor:nesw-resize; }
    .handle.tr{ right:-6px; top:-6px; cursor:nesw-resize; }
    .handle.tl{ left:-6px; top:-6px; cursor:nwse-resize; }

    .rotHandle{
      position:absolute;
      left:50%;
      top:-26px;
      width: 14px; height: 14px;
      transform: translateX(-50%);
      border-radius: 999px;
      background: rgba(245,200,107,1);
      border:1px solid rgba(0,0,0,.22);
      box-shadow: 0 12px 22px rgba(0,0,0,.25);
      z-index: 21;
      display:none;
      cursor:grab;
      touch-action:none;
    }
    .item.selected .rotHandle{ display:block; }

    .badgeDim{
      position:absolute;
      left:8px; bottom:6px;
      font-size:11px;
      font-family:var(--mono);
      color: rgba(255,255,255,.75);
      background: rgba(0,0,0,.26);
      border:1px solid rgba(255,255,255,.10);
      padding: 2px 6px;
      border-radius: 10px;
      pointer-events:none;
      display:none;
    }
    [data-theme="light"] .badgeDim{ color: rgba(17,24,39,.72); background: rgba(255,255,255,.72); border-color: rgba(17,24,39,.10); }

    .item.selected .badgeDim{ display:block; }

    .toast{
      position:fixed;
      left:50%; bottom:16px;
      transform: translateX(-50%);
      z-index: 999;
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:900;
      font-size: 13px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      max-width: min(560px, calc(100vw - 20px));
      display:none;
    }

    /* =========================================================
       HELP OVERLAY
       ========================================================= */
    .help{
      position:absolute;
      left:12px; bottom:12px;
      z-index:60;
      max-width: 520px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .helpHeader{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid var(--border);
    }
    .helpHeader .h{ font-weight:900; letter-spacing:.02em; }
    .helpBody{ padding: 10px 12px; color:var(--muted); font-weight:800; font-size:12px; line-height:1.55; }

    @media (max-width: 560px){
      .help{ display:none; } /* default closed on mobile */
    }

  </style>
</head>
<body data-theme="dark">
  <div class="app" id="app">

    <!-- =====================================================
         TOP BAR
         ===================================================== -->
    <div class="topbar">
      <div class="brand">
        <div class="brandBadge" aria-label="Sleeve heart">
          <!-- heart icon -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 21s-7.2-4.4-9.8-9.2C-.3 7.2 2.4 3.5 6.2 3.5c2 0 3.7 1 4.8 2.4 1.1-1.4 2.9-2.4 4.8-2.4 3.8 0 6.5 3.7 4 8.3C19.2 16.6 12 21 12 21z" fill="rgba(255,255,255,.92)"/>
          </svg>
        </div>
        <div class="brandTitle">
          <div class="t1">SLEEVE EVENTS</div>
          <div class="t2">Official Room Planner • Single-file Edition</div>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="toggles">
          <div class="toggle" id="toggleTheme"><div class="switch on" id="swTheme"></div><span>Dark</span></div>
          <div class="toggle" id="toggleGrid"><div class="switch on" id="swGrid"></div><span>Grid</span></div>
          <div class="toggle" id="toggleSnap"><div class="switch on" id="swSnap"></div><span>Snap</span></div>
        </div>

        <button class="btn" id="btnTools">Tools</button>
        <button class="btn" id="btnSaveLocal">Save Local</button>
        <button class="btn" id="btnLoadLocal">Load Local</button>
        <button class="btn" id="btnDownload">Download</button>
        <button class="btn" id="btnUpload">Upload</button>
        <button class="btn" id="btnShare">Copy Link</button>
        <button class="btn" id="btnExportPNG">Export PNG</button>
        <button class="btn primary" id="btnExportPDF">Export PDF</button>
      </div>
    </div>

    <!-- =====================================================
         MAIN
         ===================================================== -->
    <div class="main">

      <!-- CANVAS -->
      <div class="canvasCard">
        <div class="viewport" id="viewport">
          <div class="scene" id="scene">
            <div class="stageLayer" id="stageLayer">
              <img class="bgImage" id="bgImage" alt="" />
              <div class="room gridBold" id="room"></div>
            </div>
          </div>
        </div>

        <button class="fab" id="fab">+ Add Object</button>

        <div class="help" id="help">
          <div class="helpHeader">
            <div class="h">Controls</div>
            <button class="btn" id="btnHelpHide" style="height:28px;padding:0 10px;font-size:12px;box-shadow:none;">Hide</button>
          </div>
          <div class="helpBody">
            Pan: <span class="kbd">Space</span> + drag • Zoom: mousewheel/trackpad • Select: click • Multi-select: <span class="kbd">Shift</span>+click • Duplicate: <span class="kbd">⌘/Ctrl</span>+<span class="kbd">D</span> • Delete: <span class="kbd">Del</span>/<span class="kbd">Backspace</span> • Lock: <span class="kbd">L</span>
            <div style="margin-top:8px;">
              <span id="scaleNote">Scale not set — use <b>Set Scale</b> to get accurate feet/in.</span>
            </div>
          </div>
        </div>

      </div>

      <!-- SIDEBAR -->
      <div class="sidebar" id="sidebar">

        <div class="panel">
          <div class="panelHeader"><div class="h">Project</div></div>
          <div class="panelBody">
            <div class="row">
              <div class="col">
                <label class="small">Event Name</label>
                <input id="eventName" type="text" placeholder="e.g., Karla & Andrew Wedding" />
              </div>
            </div>
            <div style="height:10px"></div>
            <label class="small">Notes</label>
            <textarea id="eventNotes" placeholder="Load-in notes, vendor cues, timeline, etc."></textarea>
            <div style="height:10px"></div>

            <div class="row">
              <div class="col">
                <label class="small">Room Size (ft)</label>
                <div class="row">
                  <input id="roomW" type="text" value="60" />
                  <input id="roomH" type="text" value="40" />
                </div>
              </div>
              <div class="col">
                <label class="small">Grid (ft)</label>
                <select id="gridStep">
                  <option value="1">1 ft</option>
                  <option value="2" selected>2 ft</option>
                  <option value="5">5 ft</option>
                </select>
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="row">
              <button class="btn" id="btnApplyRoom" style="flex:1;">Apply Room</button>
              <button class="btn" id="btnFit" style="flex:1;">Fit</button>
            </div>

            <div style="height:10px"></div>
            <div class="row">
              <button class="btn" id="btnSetScale" style="flex:1;">Set Scale</button>
              <button class="btn" id="btnClear" style="flex:1;">Clear</button>
            </div>

            <div style="height:10px"></div>
            <label class="small">Background</label>
            <div class="row">
              <button class="btn" id="btnBgUpload" style="flex:1;">Upload</button>
              <button class="btn" id="btnBgFit" style="flex:1;">Fit</button>
            </div>
            <div style="height:8px"></div>
            <div class="chips">
              <div class="chip on" id="chipBgLock"><span class="swatch" style="background:rgba(255,255,255,.12)"></span>Lock BG</div>
              <div class="chip on" id="chipShowGrid"><span class="swatch" style="background:rgba(255,255,255,.12)"></span>Show Grid</div>
              <div class="chip on" id="chipSnap"><span class="swatch" style="background:rgba(255,255,255,.12)"></span>Snap</div>
            </div>

          </div>
        </div>

        <div class="panel">
          <div class="panelHeader"><div class="h">Objects</div></div>
          <div class="panelBody">
            <div class="palette" id="palette"></div>
            <div style="height:12px"></div>
            <div class="footerNote">Tip: place, then use <span class="kbd">⌘/Ctrl</span>+<span class="kbd">D</span> to duplicate fast. Lock with <span class="kbd">L</span>.</div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHeader"><div class="h">Selected</div></div>
          <div class="panelBody">
            <div id="selEmpty" class="footerNote">Select an object to edit label, lock, color, and size.</div>
            <div id="selPanel" class="hide">
              <label class="small">Label</label>
              <input id="selLabel" type="text" />

              <div style="height:10px"></div>
              <div class="row">
                <div class="col">
                  <label class="small">Width</label>
                  <div id="selW" class="footerNote"></div>
                </div>
                <div class="col">
                  <label class="small">Height</label>
                  <div id="selH" class="footerNote"></div>
                </div>
              </div>

              <div style="height:10px"></div>
              <div class="chips">
                <div class="chip" id="chipLock"><span class="swatch" style="background:rgba(255,255,255,.12)"></span>Lock</div>
                <div class="chip" id="chipDuplicate"><span class="swatch" style="background:rgba(255,255,255,.12)"></span>Duplicate</div>
                <div class="chip" id="chipDelete" style="border-color:rgba(255,77,77,.35);"><span class="swatch" style="background:rgba(255,77,77,.65)"></span>Delete</div>
              </div>

              <div style="height:10px"></div>
              <label class="small">Color</label>
              <div class="chips" id="colorChips"></div>

              <div style="height:10px"></div>
              <label class="small">Arrange</label>
              <div class="chips">
                <div class="chip" id="chipAlignL">Align L</div>
                <div class="chip" id="chipAlignC">Align C</div>
                <div class="chip" id="chipAlignR">Align R</div>
                <div class="chip" id="chipDistH">Distribute</div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHeader"><div class="h">Gear Summary</div></div>
          <div class="panelBody">
            <div id="gear" class="footerNote"></div>
          </div>
        </div>

      </div>

    </div>

    <!-- Mobile Sheet -->
    <div class="sheetBackdrop" id="sheetBackdrop"></div>
    <div class="sheet" id="sheet">
      <div class="sheetHandle"></div>
      <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="font-weight:900;letter-spacing:.02em;">Tools</div>
        <button class="btn" id="btnSheetClose" style="height:30px;padding:0 12px;font-size:12px;box-shadow:none;">Close</button>
      </div>

      <div class="panel" style="box-shadow:none;">
        <div class="panelHeader"><div class="h">Quick Actions</div></div>
        <div class="panelBody">
          <div class="row">
            <button class="btn" id="mSetScale" style="flex:1;">Set Scale</button>
            <button class="btn" id="mFit" style="flex:1;">Fit</button>
          </div>
          <div style="height:8px"></div>
          <div class="row">
            <button class="btn" id="mBgUpload" style="flex:1;">BG Upload</button>
            <button class="btn" id="mBgFit" style="flex:1;">BG Fit</button>
          </div>
          <div style="height:8px"></div>
          <div class="row">
            <button class="btn" id="mDemoWedding" style="flex:1;">Demo Wedding</button>
            <button class="btn" id="mDemoMitzvah" style="flex:1;">Demo Mitzvah</button>
          </div>
          <div style="height:8px"></div>
          <div class="chips">
            <div class="chip on" id="mToggleTheme"><span class="swatch" style="background:var(--accent)"></span>Theme</div>
            <div class="chip on" id="mToggleGrid"><span class="swatch" style="background:rgba(255,255,255,.12)"></span>Grid</div>
            <div class="chip on" id="mToggleSnap"><span class="swatch" style="background:rgba(255,255,255,.12)"></span>Snap</div>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="panel" style="box-shadow:none;">
        <div class="panelHeader"><div class="h">Add Objects</div></div>
        <div class="panelBody">
          <div class="palette" id="paletteMobile"></div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="panel" style="box-shadow:none;">
        <div class="panelHeader"><div class="h">Exports</div></div>
        <div class="panelBody">
          <div class="row">
            <button class="btn" id="mExportPNG" style="flex:1;">Export PNG</button>
            <button class="btn primary" id="mExportPDF" style="flex:1;">Export PDF</button>
          </div>
          <div style="height:8px"></div>
          <div class="row">
            <button class="btn" id="mShare" style="flex:1;">Copy Link</button>
            <button class="btn" id="mDownload" style="flex:1;">Download</button>
          </div>
          <div style="height:8px"></div>
          <div class="row">
            <button class="btn" id="mSaveLocal" style="flex:1;">Save Local</button>
            <button class="btn" id="mLoadLocal" style="flex:1;">Load Local</button>
          </div>
          <div style="height:8px"></div>
          <div class="row">
            <button class="btn" id="mUpload" style="flex:1;">Upload</button>
            <button class="btn" id="mClear" style="flex:1;">Clear</button>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="footerNote">Exports include branding footer: SleeveEvents.com • stephen@sleeveevents.com</div>
    </div>

    <input id="fileUpload" type="file" accept="application/json" class="hide" />
    <input id="bgUpload" type="file" accept="image/png,image/jpeg" class="hide" />

    <div class="toast" id="toast"></div>

  </div>

  <script>
    /* =========================================================
       STATE
       ========================================================= */
    const State = {
      version: 1,
      eventName: '',
      eventNotes: '',
      theme: 'dark',
      roomFt: { w: 60, h: 40 },
      pxPerFt: 40,              // default 40px = 1ft until user sets scale
      gridOn: true,
      snapOn: true,
      gridStepFt: 2,
      snapStepFt: 2,
      bg: {
        src: '',
        locked: true,
        fitMode: 'contain',
        // transform is in ROOM local coords
        x: 0, y: 0,
        scale: 1,
      },
      view: {
        // view transform for zoom/pan (screen -> stageLayer)
        zoom: 1,
        panX: 0,
        panY: 0,
      },
      items: [],
      selected: new Set(),
      // interaction
      mode: 'idle', // idle | panning | dragging | resizing | rotating | setScale
      pointer: { id: null, startX:0, startY:0, lastX:0, lastY:0 },
      drag: null,
      scaleTool: { step: 0, p1: null, p2: null },
    };

    const ExportBrand = {
      site: 'SleeveEvents.com',
      email: 'stephen@sleeveevents.com',
      tagline: 'Every Moment, With Love & Precision'
    };

    /* =========================================================
       CONSTANTS + UTILITIES
       ========================================================= */

    // Pointer capture can throw on some browsers (notably Safari/iOS) when state is not valid.
    // We always guard and we also release safely on pointerup/cancel.
    const PointerCapture = {
      el: null,
      pid: null,
      safeCapture(el, pointerId){
        try{
          if (!el || !el.isConnected) return false;
          if (pointerId === undefined || pointerId === null) return false;
          if (typeof el.setPointerCapture !== 'function') return false;

          if (this.el && this.el !== el && this.pid === pointerId){
            this.safeRelease(this.el, pointerId);
          }

          if (typeof el.hasPointerCapture === 'function'){
            if (!el.hasPointerCapture(pointerId)) el.setPointerCapture(pointerId);
          } else {
            el.setPointerCapture(pointerId);
          }

          this.el = el;
          this.pid = pointerId;
          return true;
        } catch(_){
          return false;
        }
      },
      safeRelease(el, pointerId){
        try{
          if (!el) return;
          if (typeof el.releasePointerCapture !== 'function') return;
          if (typeof el.hasPointerCapture === 'function'){
            if (el.hasPointerCapture(pointerId)) el.releasePointerCapture(pointerId);
          } else {
            el.releasePointerCapture(pointerId);
          }
        } catch(_){
          // ignore
        } finally {
          if (this.el === el && this.pid === pointerId){
            this.el = null;
            this.pid = null;
          }
        }
      },
      reset(pointerId){
        if (this.el && this.pid === pointerId){
          this.safeRelease(this.el, pointerId);
        }
      }
    };

    const uid = () => Math.random().toString(36).slice(2, 10);

    function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
    function roundTo(v, step){ return Math.round(v/step)*step; }
    function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
    function safeFile(name){ return (name||'').replace(/[^a-z0-9\-\_]+/gi,'_').slice(0,80); }

    function normalizeAngle(deg){
      let a = deg % 360;
      if (a < 0) a += 360;
      // avoid -0
      return Math.round(a * 1000) / 1000;
    }

    function ftInFromPx(px){
      const ft = px / State.pxPerFt;
      const totalIn = ft * 12;
      const rIn = Math.round(totalIn);
      const oFt = Math.floor(rIn / 12);
      const oIn = rIn % 12;
      return { ft: oFt, inch: oIn, rawFt: ft };
    }

    function fmtFtIn(px){
      if (!State.pxPerFt || State.pxPerFt <= 0) return '—';
      const d = ftInFromPx(px);
      return `${d.ft}' ${d.inch}\"`;
    }

    function snapPx(px){
      if (!State.snapOn || !State.pxPerFt) return px;
      const stepPx = State.snapStepFt * State.pxPerFt;
      return roundTo(px, stepPx);
    }

    function toast(msg){
      const el = UI.toast;
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.style.display='none', 1800);
    }

    function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }

    function encodeProjectToURL(project){
      const json = JSON.stringify(project);
      const b64 = btoa(unescape(encodeURIComponent(json)));
      // keep reasonably short; if huge background stored, this could get too big.
      return `${location.origin}${location.pathname}#p=${b64}`;
    }

    function decodeProjectFromURL(){
      const h = location.hash || '';
      const m = h.match(/#p=([A-Za-z0-9+/=]+)/);
      if (!m) return null;
      try{
        const json = decodeURIComponent(escape(atob(m[1])));
        return JSON.parse(json);
      } catch(_){
        return null;
      }
    }

    /* =========================================================
       OBJECT DEFINITIONS
       ========================================================= */
    const COLORS = [
      { key:'brand', name:'Purple', hex:'#8b5cf6' },
      { key:'pink',  name:'Pink',   hex:'#ff4fa3' },
      { key:'black', name:'Black',  hex:'#0b1020' },
      { key:'white', name:'White',  hex:'#ffffff' },
      { key:'gold',  name:'Gold',   hex:'#f5c86b' },
      { key:'blue',  name:'Blue',   hex:'#40a2ff' },
      { key:'green', name:'Green',  hex:'#22c55e' },
    ];

    const ObjectDefs = [
      { type:'dj_booth',     name:'DJ Booth',        note:'6ft',   wFt:6,  hFt:3,  color:'brand' },
      { type:'speaker_pair', name:'Speaker Pair',    note:'L/R',   wFt:2.5,hFt:2,  color:'blue', meta:{pair:true} },
      { type:'dance_floor',  name:'Dance Floor',     note:'12×12', wFt:12, hFt:12, color:'gold' },
      { type:'photo_booth',  name:'Photobooth',      note:'8×8',   wFt:8,  hFt:8,  color:'pink' },
      { type:'round_48',     name:'Round Table',     note:'48"',   wFt:4,  hFt:4,  color:'green', shape:'circle' },
      { type:'round_60',     name:'Round Table',     note:'60"',   wFt:5,  hFt:5,  color:'green', shape:'circle' },
      { type:'round_72',     name:'Round Table',     note:'72"',   wFt:6,  hFt:6,  color:'green', shape:'circle' },
      { type:'rect_6',       name:'Rect Table',      note:'6ft',   wFt:6,  hFt:2.5,color:'green' },
      { type:'bar',          name:'Bar',             note:'',      wFt:12, hFt:3,  color:'blue' },
      { type:'stage',        name:'Stage',           note:'',      wFt:16, hFt:8,  color:'brand' },
      { type:'cocktail',     name:'Cocktail Table',  note:'High',  wFt:2.5,hFt:2.5,color:'green', shape:'circle' },
      { type:'sweetheart',   name:'Sweetheart',      note:'B&G',   wFt:6,  hFt:2.5,color:'pink' },
      { type:'head_table',   name:'Head Table',      note:'Long',  wFt:18, hFt:3,  color:'pink' },
      { type:'arch',         name:'Ceremony Arch',   note:'',      wFt:10, hFt:2,  color:'gold' },
      { type:'uplight',      name:'Uplight',         note:'',      wFt:0.5,hFt:0.5,color:'purple', shape:'circle', meta:{fixture:'uplight'} },
      { type:'moving_head',  name:'Moving Head',     note:'',      wFt:1,  hFt:1,  color:'purple', shape:'circle', meta:{fixture:'moving'} },
      { type:'truss',        name:'Truss',           note:'10ft',  wFt:10, hFt:1,  color:'black' },
      { type:'custom_rect',  name:'Custom Rect',     note:'',      wFt:6,  hFt:4,  color:'brand' },
    ].map(d=>({ ...d, color: d.color === 'purple' ? 'brand' : d.color }));

    function defByType(t){ return ObjectDefs.find(o=>o.type===t); }

    /* =========================================================
       UI REFERENCES
       ========================================================= */
    const UI = {
      viewport: document.getElementById('viewport'),
      stageLayer: document.getElementById('stageLayer'),
      room: document.getElementById('room'),
      bgImage: document.getElementById('bgImage'),
      palette: document.getElementById('palette'),
      paletteMobile: document.getElementById('paletteMobile'),
      sidebar: document.getElementById('sidebar'),
      toast: document.getElementById('toast'),

      eventName: document.getElementById('eventName'),
      eventNotes: document.getElementById('eventNotes'),
      roomW: document.getElementById('roomW'),
      roomH: document.getElementById('roomH'),
      gridStep: document.getElementById('gridStep'),
      gear: document.getElementById('gear'),

      btnApplyRoom: document.getElementById('btnApplyRoom'),
      btnFit: document.getElementById('btnFit'),
      btnSetScale: document.getElementById('btnSetScale'),
      btnClear: document.getElementById('btnClear'),

      btnBgUpload: document.getElementById('btnBgUpload'),
      btnBgFit: document.getElementById('btnBgFit'),
      chipBgLock: document.getElementById('chipBgLock'),
      chipShowGrid: document.getElementById('chipShowGrid'),
      chipSnap: document.getElementById('chipSnap'),

      btnSaveLocal: document.getElementById('btnSaveLocal'),
      btnLoadLocal: document.getElementById('btnLoadLocal'),
      btnDownload: document.getElementById('btnDownload'),
      btnUpload: document.getElementById('btnUpload'),
      btnShare: document.getElementById('btnShare'),
      btnExportPNG: document.getElementById('btnExportPNG'),
      btnExportPDF: document.getElementById('btnExportPDF'),

      btnTools: document.getElementById('btnTools'),

      toggleTheme: document.getElementById('toggleTheme'),
      toggleGrid: document.getElementById('toggleGrid'),
      toggleSnap: document.getElementById('toggleSnap'),
      swTheme: document.getElementById('swTheme'),
      swGrid: document.getElementById('swGrid'),
      swSnap: document.getElementById('swSnap'),

      help: document.getElementById('help'),
      btnHelpHide: document.getElementById('btnHelpHide'),
      scaleNote: document.getElementById('scaleNote'),

      fileUpload: document.getElementById('fileUpload'),
      bgUpload: document.getElementById('bgUpload'),

      // selected
      selEmpty: document.getElementById('selEmpty'),
      selPanel: document.getElementById('selPanel'),
      selLabel: document.getElementById('selLabel'),
      selW: document.getElementById('selW'),
      selH: document.getElementById('selH'),
      chipLock: document.getElementById('chipLock'),
      chipDuplicate: document.getElementById('chipDuplicate'),
      chipDelete: document.getElementById('chipDelete'),
      colorChips: document.getElementById('colorChips'),
      chipAlignL: document.getElementById('chipAlignL'),
      chipAlignC: document.getElementById('chipAlignC'),
      chipAlignR: document.getElementById('chipAlignR'),
      chipDistH: document.getElementById('chipDistH'),

      // mobile
      fab: document.getElementById('fab'),
      sheetBackdrop: document.getElementById('sheetBackdrop'),
      sheet: document.getElementById('sheet'),
      btnSheetClose: document.getElementById('btnSheetClose'),
      mSetScale: document.getElementById('mSetScale'),
      mFit: document.getElementById('mFit'),
      mBgUpload: document.getElementById('mBgUpload'),
      mBgFit: document.getElementById('mBgFit'),
      mDemoWedding: document.getElementById('mDemoWedding'),
      mDemoMitzvah: document.getElementById('mDemoMitzvah'),
      mToggleTheme: document.getElementById('mToggleTheme'),
      mToggleGrid: document.getElementById('mToggleGrid'),
      mToggleSnap: document.getElementById('mToggleSnap'),
      mExportPNG: document.getElementById('mExportPNG'),
      mExportPDF: document.getElementById('mExportPDF'),
      mShare: document.getElementById('mShare'),
      mDownload: document.getElementById('mDownload'),
      mSaveLocal: document.getElementById('mSaveLocal'),
      mLoadLocal: document.getElementById('mLoadLocal'),
      mUpload: document.getElementById('mUpload'),
      mClear: document.getElementById('mClear'),
    };

    /* =========================================================
       RENDERING
       ========================================================= */
    function applyTheme(){
      document.body.setAttribute('data-theme', State.theme);
      const on = State.theme === 'dark';
      UI.swTheme.classList.toggle('on', on);
      UI.toggleTheme.querySelector('span').textContent = on ? 'Dark' : 'Light';
      UI.mToggleTheme.classList.toggle('on', true);
    }

    function applyRoom(){
      const w = clamp(parseFloat(UI.roomW.value)||State.roomFt.w, 5, 400);
      const h = clamp(parseFloat(UI.roomH.value)||State.roomFt.h, 5, 400);
      State.roomFt.w = w; State.roomFt.h = h;
      const pxW = w * State.pxPerFt;
      const pxH = h * State.pxPerFt;
      UI.room.style.width = pxW + 'px';
      UI.room.style.height = pxH + 'px';
      UI.stageLayer.style.width = pxW + 'px';
      UI.stageLayer.style.height = pxH + 'px';
      // Ensure bg stays in bounds visually (not strict)
      renderBg();
      renderGrid();
      renderItems();
      updateGear();
      updateScaleNote();
    }

    function renderGrid(){
      UI.room.classList.toggle('gridBold', true);
      UI.room.style.display = State.gridOn ? 'block' : 'block';
      const stepPx = State.gridStepFt * State.pxPerFt;
      UI.room.style.backgroundSize = `${stepPx}px ${stepPx}px, ${stepPx}px ${stepPx}px, ${stepPx*5}px ${stepPx*5}px, ${stepPx*5}px ${stepPx*5}px`;
      UI.swGrid.classList.toggle('on', State.gridOn);
      UI.swSnap.classList.toggle('on', State.snapOn);
      UI.chipShowGrid.classList.toggle('on', State.gridOn);
      UI.chipSnap.classList.toggle('on', State.snapOn);
      UI.mToggleGrid.classList.toggle('on', State.gridOn);
      UI.mToggleSnap.classList.toggle('on', State.snapOn);
      UI.toggleGrid.querySelector('span').textContent = State.gridOn ? 'Grid' : 'Grid';
      UI.toggleSnap.querySelector('span').textContent = State.snapOn ? 'Snap' : 'Snap';
    }

    function applyView(){
      const z = State.view.zoom;
      const x = State.view.panX;
      const y = State.view.panY;
      UI.stageLayer.style.transform = `translate(${x}px, ${y}px) scale(${z})`;
    }

    function screenToRoomPoint(clientX, clientY){
      const rect = UI.viewport.getBoundingClientRect();
      const sx = clientX - rect.left;
      const sy = clientY - rect.top;

      // stageLayer transform: translate(panX, panY) then scale(zoom) around center
      // We set stageLayer transform with translate + scale, but stageLayer is positioned with left:50%,top:50% translate(-50%,-50%) in CSS.
      // To keep it stable, we compute based on DOM matrix.
      const m = new DOMMatrix(getComputedStyle(UI.stageLayer).transform);
      // invert transform
      const inv = m.inverse();
      const p = new DOMPoint(sx, sy).matrixTransform(inv);
      return { x: p.x, y: p.y };
    }

    function roomToScreenPoint(x,y){
      const m = new DOMMatrix(getComputedStyle(UI.stageLayer).transform);
      const p = new DOMPoint(x,y).matrixTransform(m);
      return { x: p.x, y: p.y };
    }

    function renderBg(){
      if (!State.bg.src){
        UI.bgImage.style.display = 'none';
        return;
      }
      UI.bgImage.style.display = 'block';
      UI.bgImage.src = State.bg.src;
      UI.bgImage.style.transform = `translate(${State.bg.x}px, ${State.bg.y}px) scale(${State.bg.scale})`;
      UI.chipBgLock.classList.toggle('on', State.bg.locked);
    }

    function clearItemsDom(){
      const els = UI.room.querySelectorAll('.item');
      els.forEach(e=>e.remove());
    }

    function colorHex(key){
      const c = COLORS.find(c=>c.key===key);
      return c ? c.hex : '#8b5cf6';
    }

    function computeItemStyle(it){
      const hex = colorHex(it.color || 'brand');
      const bg = `linear-gradient(135deg, ${hex}, rgba(255,255,255,.06))`;
      return { hex, bg };
    }

    function renderItems(){
      clearItemsDom();
      for (const it of State.items){
        const el = document.createElement('div');
        el.className = 'item';
        el.dataset.id = it.id;
        const d = defByType(it.type);
        if (d?.shape === 'circle') el.style.borderRadius = '999px';

        const { bg } = computeItemStyle(it);
        el.style.background = bg;

        el.style.left = it.x + 'px';
        el.style.top  = it.y + 'px';
        el.style.width = it.w + 'px';
        el.style.height= it.h + 'px';
        el.style.transform = `rotate(${it.rot}deg)`;

        el.classList.toggle('selected', State.selected.has(it.id));
        el.classList.toggle('locked', !!it.locked);

        el.textContent = it.label || (d?.name || 'Object');

        // handles
        const br = document.createElement('div'); br.className='handle br';
        const bl = document.createElement('div'); bl.className='handle bl';
        const tr = document.createElement('div'); tr.className='handle tr';
        const tl = document.createElement('div'); tl.className='handle tl';
        const rot = document.createElement('div'); rot.className='rotHandle';
        const badge = document.createElement('div'); badge.className='badgeDim';

        const wTxt = fmtFtIn(it.w);
        const hTxt = fmtFtIn(it.h);
        badge.textContent = `${wTxt} × ${hTxt}`;

        el.appendChild(br); el.appendChild(bl); el.appendChild(tr); el.appendChild(tl);
        el.appendChild(rot);
        el.appendChild(badge);

        // pointer interactions
        el.addEventListener('pointerdown', (e)=>onItemPointerDown(e, it.id));
        br.addEventListener('pointerdown', (e)=>onHandleDown(e, it.id, 'br'));
        bl.addEventListener('pointerdown', (e)=>onHandleDown(e, it.id, 'bl'));
        tr.addEventListener('pointerdown', (e)=>onHandleDown(e, it.id, 'tr'));
        tl.addEventListener('pointerdown', (e)=>onHandleDown(e, it.id, 'tl'));
        rot.addEventListener('pointerdown', (e)=>onRotateDown(e, it.id));

        UI.room.appendChild(el);
      }
      updateSelectedPanel();
      updateGear();
    }

    function updateScaleNote(){
      UI.scaleNote.textContent = State.pxPerFt ? `Scale: 1 ft = ${Math.round(State.pxPerFt)} px • Grid ${State.gridStepFt}ft • Snap ${State.snapStepFt}ft` : 'Scale not set — use Set Scale.';
    }

    /* =========================================================
       SELECTION + EDIT
       ========================================================= */
    function getItem(id){ return State.items.find(i=>i.id===id) || null; }

    function clearSelection(){ State.selected.clear(); }

    function selectOnly(id){ State.selected.clear(); if (id) State.selected.add(id); }

    function toggleSelection(id){
      if (State.selected.has(id)) State.selected.delete(id);
      else State.selected.add(id);
    }

    function updateSelectedPanel(){
      const ids = [...State.selected];
      if (ids.length === 1){
        const it = getItem(ids[0]);
        UI.selEmpty.classList.add('hide');
        UI.selPanel.classList.remove('hide');
        UI.selLabel.value = it.label || '';
        UI.selW.textContent = fmtFtIn(it.w);
        UI.selH.textContent = fmtFtIn(it.h);
        UI.chipLock.classList.toggle('on', !!it.locked);
        buildColorChips(it.color || 'brand');
      } else {
        UI.selEmpty.classList.remove('hide');
        UI.selPanel.classList.add('hide');
      }
    }

    function buildColorChips(activeKey){
      UI.colorChips.innerHTML = '';
      for (const c of COLORS){
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `<span class="swatch" style="background:${c.hex}"></span>${c.name}`;
        chip.classList.toggle('on', c.key === activeKey);
        chip.addEventListener('click', ()=>{
          const ids = [...State.selected];
          if (ids.length !== 1) return;
          const it = getItem(ids[0]);
          it.color = c.key;
          renderItems();
        });
        UI.colorChips.appendChild(chip);
      }
    }

    function deleteSelected(){
      const ids = new Set(State.selected);
      State.items = State.items.filter(i=>!ids.has(i.id));
      clearSelection();
      renderItems();
      toast('Deleted');
    }

    function duplicateSelected(){
      const ids = [...State.selected];
      if (!ids.length) return;
      const newIds = [];
      for (const id of ids){
        const src = getItem(id);
        const copy = deepCopy(src);
        copy.id = uid();
        copy.x += 20; copy.y += 20;
        copy.label = (copy.label || defByType(copy.type)?.name || 'Object');
        State.items.push(copy);
        newIds.push(copy.id);
      }
      State.selected = new Set(newIds);
      renderItems();
      toast('Duplicated');
    }

    function toggleLockSelected(){
      const ids = [...State.selected];
      if (ids.length !== 1) return;
      const it = getItem(ids[0]);
      it.locked = !it.locked;
      renderItems();
      toast(it.locked ? 'Locked' : 'Unlocked');
    }

    function alignSelected(mode){
      const ids = [...State.selected];
      if (ids.length < 2) return;
      const items = ids.map(getItem).filter(Boolean);
      if (!items.length) return;
      if (mode==='L'){
        const minX = Math.min(...items.map(i=>i.x));
        items.forEach(i=>{ if(!i.locked) i.x = minX; });
      }
      if (mode==='C'){
        const minX = Math.min(...items.map(i=>i.x));
        const maxX = Math.max(...items.map(i=>i.x + i.w));
        const center = (minX + maxX)/2;
        items.forEach(i=>{ if(!i.locked) i.x = center - i.w/2; });
      }
      if (mode==='R'){
        const maxX = Math.max(...items.map(i=>i.x + i.w));
        items.forEach(i=>{ if(!i.locked) i.x = maxX - i.w; });
      }
      renderItems();
      toast('Aligned');
    }

    function distributeSelected(){
      const ids = [...State.selected];
      if (ids.length < 3) return;
      const items = ids.map(getItem).filter(Boolean).sort((a,b)=>a.x-b.x);
      const first = items[0];
      const last = items[items.length-1];
      const span = (last.x - first.x);
      const step = span/(items.length-1);
      items.forEach((i,idx)=>{ if(idx===0||idx===items.length-1) return; if(!i.locked) i.x = first.x + step*idx; });
      renderItems();
      toast('Distributed');
    }

    /* =========================================================
       ITEMS: CREATE
       ========================================================= */
    function addItem(type, at){
      const d = defByType(type);
      if (!d) return;
      const id = uid();
      const w = d.wFt * State.pxPerFt;
      const h = d.hFt * State.pxPerFt;
      const x = snapPx(clamp(at.x - w/2, 0, State.roomFt.w*State.pxPerFt - w));
      const y = snapPx(clamp(at.y - h/2, 0, State.roomFt.h*State.pxPerFt - h));
      const it = {
        id,
        type,
        label: d.name,
        x, y,
        w, h,
        rot: 0,
        locked:false,
        color: d.color || 'brand'
      };
      State.items.push(it);
      selectOnly(id);
      renderItems();
      toast(`Added ${d.name}`);
    }

    function buildPalette(){
      UI.palette.innerHTML = '';
      UI.paletteMobile.innerHTML = '';
      for (const d of ObjectDefs){
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.innerHTML = `<div><div class="name">${d.name}</div><div class="note">${d.note||''}</div></div><div class="swatch" style="background:${colorHex(d.color||'brand')}"></div>`;
        tile.addEventListener('click', ()=>{
          // center of room
          addItem(d.type, { x: (State.roomFt.w*State.pxPerFt)/2, y: (State.roomFt.h*State.pxPerFt)/2 });
          closeSheet();
        });
        UI.palette.appendChild(tile);

        const tileM = tile.cloneNode(true);
        tileM.addEventListener('click', ()=>{
          addItem(d.type, { x: (State.roomFt.w*State.pxPerFt)/2, y: (State.roomFt.h*State.pxPerFt)/2 });
          closeSheet();
        });
        UI.paletteMobile.appendChild(tileM);
      }
    }

    /* =========================================================
       GEAR SUMMARY
       ========================================================= */
    function updateGear(){
      const counts = new Map();
      for (const it of State.items){
        const d = defByType(it.type);
        const key = d?.name || it.type;
        // Special case: speaker pair counts as 2 speakers
        if (it.type === 'speaker_pair'){
          counts.set('Speakers', (counts.get('Speakers')||0) + 2);
          continue;
        }
        // Uplights and moving heads
        if (it.type === 'uplight'){
          counts.set('Uplights', (counts.get('Uplights')||0) + 1);
          continue;
        }
        if (it.type === 'moving_head'){
          counts.set('Moving Heads', (counts.get('Moving Heads')||0) + 1);
          continue;
        }

        counts.set(key, (counts.get(key)||0) + 1);
      }

      const lines = [];
      if (!State.items.length){
        UI.gear.textContent = 'No objects yet.';
        return;
      }
      for (const [k,v] of [...counts.entries()].sort((a,b)=>a[0].localeCompare(b[0]))){
        lines.push(`• ${k}: ${v}`);
      }
      UI.gear.textContent = lines.join('\n');
    }

    /* =========================================================
       INTERACTIONS
       ========================================================= */
    function setMode(m){ State.mode = m; }

    function isPanKey(){ return Key.space; }

    const Key = { space:false, shift:false, meta:false, ctrl:false };

    window.addEventListener('keydown', (e)=>{
      if (e.code === 'Space') Key.space = true;
      if (e.key === 'Shift') Key.shift = true;
      if (e.metaKey) Key.meta = true;
      if (e.ctrlKey) Key.ctrl = true;

      // shortcuts
      const isCmd = e.metaKey || e.ctrlKey;
      if (isCmd && e.key.toLowerCase() === 'd'){
        e.preventDefault();
        duplicateSelected();
      }
      if (e.key === 'Backspace' || e.key === 'Delete'){
        if (document.activeElement && ['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
        deleteSelected();
      }
      if (e.key.toLowerCase() === 'l'){
        if (document.activeElement && ['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
        toggleLockSelected();
      }
    });

    window.addEventListener('keyup', (e)=>{
      if (e.code === 'Space') Key.space = false;
      if (e.key === 'Shift') Key.shift = false;
      Key.meta = e.metaKey;
      Key.ctrl = e.ctrlKey;
    });

    function onItemPointerDown(e, id){
      e.preventDefault();
      const it = getItem(id);
      if (!it) return;

      // selection
      if (Key.shift) toggleSelection(id);
      else selectOnly(id);

      if (it.locked){
        renderItems();
        return;
      }

      // start drag
      setMode('dragging');
      State.pointer.id = e.pointerId;
      PointerCapture.safeCapture(e.currentTarget, e.pointerId);

      const p = screenToRoomPoint(e.clientX, e.clientY);
      State.drag = {
        kind:'move',
        id,
        start: { x: p.x, y: p.y },
        orig: { x: it.x, y: it.y }
      };

      renderItems();
    }

    function onHandleDown(e, id, corner){
      e.preventDefault();
      e.stopPropagation();
      const it = getItem(id);
      if (!it || it.locked) return;
      selectOnly(id);
      setMode('resizing');
      State.pointer.id = e.pointerId;
      PointerCapture.safeCapture(e.currentTarget, e.pointerId);
      const p = screenToRoomPoint(e.clientX, e.clientY);
      State.drag = {
        kind:'resize',
        id,
        corner,
        start: { x:p.x, y:p.y },
        orig: { x: it.x, y: it.y, w: it.w, h: it.h }
      };
      renderItems();
    }

    function onRotateDown(e, id){
      e.preventDefault();
      e.stopPropagation();
      const it = getItem(id);
      if (!it || it.locked) return;
      selectOnly(id);
      setMode('rotating');
      State.pointer.id = e.pointerId;
      PointerCapture.safeCapture(e.currentTarget, e.pointerId);
      const p = screenToRoomPoint(e.clientX, e.clientY);
      const cx = it.x + it.w/2;
      const cy = it.y + it.h/2;
      const ang0 = Math.atan2(p.y - cy, p.x - cx) * 180/Math.PI;
      State.drag = {
        kind:'rotate',
        id,
        center:{x:cx,y:cy},
        ang0,
        origRot: it.rot
      };
      renderItems();
    }

    UI.viewport.addEventListener('pointerdown', (e)=>{
      // Click empty space: selection clear (unless shift)
      const inRoom = e.target === UI.room || e.target === UI.viewport || e.target === UI.scene || e.target === UI.stageLayer;
      const isItem = e.target.closest && e.target.closest('.item');

      // scale tool
      if (State.mode === 'setScale'){
        e.preventDefault();
        const p = screenToRoomPoint(e.clientX, e.clientY);
        if (State.scaleTool.step === 0){
          State.scaleTool.p1 = p;
          State.scaleTool.step = 1;
          toast('Scale: click second point');
        } else {
          State.scaleTool.p2 = p;
          const px = dist(State.scaleTool.p1, State.scaleTool.p2);
          const ft = prompt('Enter real-world length in feet (e.g., 20):', '20');
          const ftNum = parseFloat(ft||'');
          if (ftNum && ftNum > 0){
            State.pxPerFt = px / ftNum;
            toast(`Scale set: 1ft = ${Math.round(State.pxPerFt)}px`);
            // update sizes proportionally? we keep existing pixels as-is
            applyRoom();
          } else {
            toast('Scale cancelled');
          }
          State.scaleTool.step = 0;
          State.scaleTool.p1 = null;
          State.scaleTool.p2 = null;
          setMode('idle');
        }
        return;
      }

      if (!isItem && inRoom){
        if (!Key.shift) clearSelection();
        renderItems();
      }

      // pan
      if (isPanKey()){
        e.preventDefault();
        setMode('panning');
        State.pointer.id = e.pointerId;
        PointerCapture.safeCapture(UI.viewport, e.pointerId);
        State.pointer.startX = e.clientX;
        State.pointer.startY = e.clientY;
        State.pointer.lastX = e.clientX;
        State.pointer.lastY = e.clientY;
      }
    });

    UI.viewport.addEventListener('pointermove', (e)=>{
      if (State.pointer.id !== e.pointerId) return;

      // panning
      if (State.mode === 'panning'){
        const dx = e.clientX - State.pointer.lastX;
        const dy = e.clientY - State.pointer.lastY;
        State.pointer.lastX = e.clientX;
        State.pointer.lastY = e.clientY;
        State.view.panX += dx;
        State.view.panY += dy;
        applyView();
        return;
      }

      // item interactions
      if (!State.drag) return;
      const it = getItem(State.drag.id);
      if (!it) return;
      const p = screenToRoomPoint(e.clientX, e.clientY);

      if (State.drag.kind === 'move'){
        const dx = p.x - State.drag.start.x;
        const dy = p.y - State.drag.start.y;
        let nx = State.drag.orig.x + dx;
        let ny = State.drag.orig.y + dy;
        nx = clamp(nx, 0, State.roomFt.w*State.pxPerFt - it.w);
        ny = clamp(ny, 0, State.roomFt.h*State.pxPerFt - it.h);
        it.x = snapPx(nx);
        it.y = snapPx(ny);
        renderItems();
      }

      if (State.drag.kind === 'resize'){
        const o = State.drag.orig;
        let nx=o.x, ny=o.y, nw=o.w, nh=o.h;
        const dx = p.x - State.drag.start.x;
        const dy = p.y - State.drag.start.y;
        const min = State.pxPerFt * 0.5;

        if (State.drag.corner==='br'){
          nw = clamp(o.w + dx, min, State.roomFt.w*State.pxPerFt);
          nh = clamp(o.h + dy, min, State.roomFt.h*State.pxPerFt);
        }
        if (State.drag.corner==='tr'){
          nw = clamp(o.w + dx, min, State.roomFt.w*State.pxPerFt);
          nh = clamp(o.h - dy, min, State.roomFt.h*State.pxPerFt);
          ny = o.y + (o.h - nh);
        }
        if (State.drag.corner==='bl'){
          nw = clamp(o.w - dx, min, State.roomFt.w*State.pxPerFt);
          nh = clamp(o.h + dy, min, State.roomFt.h*State.pxPerFt);
          nx = o.x + (o.w - nw);
        }
        if (State.drag.corner==='tl'){
          nw = clamp(o.w - dx, min, State.roomFt.w*State.pxPerFt);
          nh = clamp(o.h - dy, min, State.roomFt.h*State.pxPerFt);
          nx = o.x + (o.w - nw);
          ny = o.y + (o.h - nh);
        }

        // clamp to room
        nx = clamp(nx, 0, State.roomFt.w*State.pxPerFt - nw);
        ny = clamp(ny, 0, State.roomFt.h*State.pxPerFt - nh);
        it.x = snapPx(nx);
        it.y = snapPx(ny);
        it.w = Math.max(min, snapPx(nw));
        it.h = Math.max(min, snapPx(nh));
        renderItems();
      }

      if (State.drag.kind === 'rotate'){
        const cx = State.drag.center.x;
        const cy = State.drag.center.y;
        const ang = Math.atan2(p.y - cy, p.x - cx) * 180/Math.PI;
        it.rot = normalizeAngle(State.drag.origRot + (ang - State.drag.ang0));
        renderItems();
      }
    });

    UI.viewport.addEventListener('pointerup', (e) => {
      if (State.pointer.id !== e.pointerId) return;
      PointerCapture.reset(e.pointerId);
      State.pointer.id = null;
      State.drag = null;
      if (State.mode !== 'setScale') setMode('idle');
      updateSelectedPanel();
    });

    UI.viewport.addEventListener('pointercancel', (e) => {
      if (State.pointer.id === e.pointerId){
        PointerCapture.reset(e.pointerId);
        State.pointer.id = null;
        State.drag = null;
        if (State.mode !== 'setScale') setMode('idle');
        updateSelectedPanel();
      }
    });

    // zoom
    UI.viewport.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const delta = -e.deltaY;
      const factor = delta > 0 ? 1.08 : 0.92;
      const newZoom = clamp(State.view.zoom * factor, 0.25, 4);
      State.view.zoom = newZoom;
      applyView();
    }, { passive:false });

    /* =========================================================
       BACKGROUND
       ========================================================= */
    function bgFit(){
      if (!State.bg.src){ toast('No background'); return; }
      // fit within room (contain)
      const img = UI.bgImage;
      const rw = State.roomFt.w * State.pxPerFt;
      const rh = State.roomFt.h * State.pxPerFt;
      const iw = img.naturalWidth || rw;
      const ih = img.naturalHeight || rh;
      const s = Math.min(rw/iw, rh/ih);
      State.bg.scale = s;
      State.bg.x = (rw - iw*s)/2;
      State.bg.y = (rh - ih*s)/2;
      renderBg();
      toast('Background fit');
    }

    UI.bgUpload.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const data = await fileToDataURL(f);
      State.bg.src = data;
      // wait for image to load
      UI.bgImage.onload = ()=>{ bgFit(); };
      renderBg();
      UI.bgUpload.value = '';
    });

    function fileToDataURL(file){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    /* =========================================================
       SAVE / LOAD
       ========================================================= */
    function getProject(){
      return {
        version: State.version,
        eventName: State.eventName,
        eventNotes: State.eventNotes,
        theme: State.theme,
        roomFt: State.roomFt,
        pxPerFt: State.pxPerFt,
        gridOn: State.gridOn,
        snapOn: State.snapOn,
        gridStepFt: State.gridStepFt,
        snapStepFt: State.snapStepFt,
        bg: State.bg,
        view: State.view,
        items: State.items,
      };
    }

    function loadProject(p){
      if (!p || typeof p !== 'object') return;
      State.version = p.version || 1;
      State.eventName = p.eventName || '';
      State.eventNotes = p.eventNotes || '';
      State.theme = p.theme || 'dark';
      State.roomFt = p.roomFt || {w:60,h:40};
      State.pxPerFt = p.pxPerFt || 40;
      State.gridOn = (p.gridOn !== undefined) ? p.gridOn : true;
      State.snapOn = (p.snapOn !== undefined) ? p.snapOn : true;
      State.gridStepFt = p.gridStepFt || 2;
      State.snapStepFt = p.snapStepFt || State.gridStepFt;
      State.bg = p.bg || State.bg;
      State.view = p.view || State.view;
      State.items = Array.isArray(p.items) ? p.items : [];
      clearSelection();

      // sync UI
      UI.eventName.value = State.eventName;
      UI.eventNotes.value = State.eventNotes;
      UI.roomW.value = State.roomFt.w;
      UI.roomH.value = State.roomFt.h;
      UI.gridStep.value = String(State.gridStepFt);
      State.snapStepFt = State.gridStepFt;

      applyTheme();
      renderBg();
      applyRoom();
      applyView();
      renderItems();
      renderGrid();
      updateGear();
      updateScaleNote();

      toast('Loaded');
    }

    function downloadProject(){
      const p = getProject();
      const name = safeFile(State.eventName || 'SleeveEvents_RoomPlan') || 'SleeveEvents_RoomPlan';
      const blob = new Blob([JSON.stringify(p, null, 2)], { type:'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${name}.json`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 800);
      toast('Downloaded project');
    }

    function uploadProject(){
      UI.fileUpload.click();
    }

    UI.fileUpload.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const txt = await f.text();
      try{
        const p = JSON.parse(txt);
        loadProject(p);
      } catch(err){
        alert('Invalid JSON file');
      }
      UI.fileUpload.value = '';
    });

    function saveLocal(){
      const p = getProject();
      localStorage.setItem('sleeve_room_planner_v1', JSON.stringify(p));
      toast('Saved locally');
    }

    function loadLocal(){
      const txt = localStorage.getItem('sleeve_room_planner_v1');
      if (!txt){ toast('No local save'); return; }
      try{
        loadProject(JSON.parse(txt));
      } catch(_){
        toast('Local save corrupted');
      }
    }

    /* =========================================================
       SHARE LINK
       ========================================================= */
    async function copyShareLink(){
      const url = encodeProjectToURL(getProject());
      try{
        await navigator.clipboard.writeText(url);
        toast('Share link copied');
      } catch(_){
        prompt('Copy link:', url);
      }
    }

    /* =========================================================
       DEMOS
       ========================================================= */
    function demoWedding(){
      const p = getProject();
      p.eventName = 'Demo Wedding';
      p.eventNotes = 'Demo layout: tables, sweetheart table, DJ, dance floor, uplights.';
      p.roomFt = { w: 80, h: 50 };
      p.gridStepFt = 2;
      p.snapStepFt = 2;
      p.items = [];
      // place DJ + dance floor
      const px = p.pxPerFt;
      const add = (type, xFt, yFt, rot=0, label=null)=>{
        const d = defByType(type);
        p.items.push({
          id: uid(),
          type,
          label: label || d.name,
          x: xFt*px,
          y: yFt*px,
          w: d.wFt*px,
          h: d.hFt*px,
          rot,
          locked:false,
          color: d.color
        });
      };
      add('dj_booth', 36, 6, 0);
      add('speaker_pair', 28, 6, 0, 'Speakers');
      add('dance_floor', 34, 16, 0);
      add('sweetheart', 36, 32, 0);
      add('photo_booth', 64, 10, 0);

      // rounds grid
      for (let r=0;r<3;r++){
        for (let c=0;c<5;c++){
          add('round_60', 10 + c*10, 10 + r*10, 0);
        }
      }

      // uplights around perimeter
      for (let i=0;i<14;i++) add('uplight', 2 + i*5, 2);
      for (let i=0;i<10;i++) add('uplight', 2, 5 + i*4);
      for (let i=0;i<14;i++) add('uplight', 2 + i*5, 48);
      for (let i=0;i<10;i++) add('uplight', 78, 5 + i*4);

      loadProject(p);
      toast('Loaded demo wedding');
    }

    function demoMitzvah(){
      const p = getProject();
      p.eventName = 'Demo Bar Mitzvah';
      p.eventNotes = 'Demo layout: dance floor center, DJ & stage, lounge + tables.';
      p.roomFt = { w: 70, h: 45 };
      p.gridStepFt = 2;
      p.snapStepFt = 2;
      p.items = [];
      const px = p.pxPerFt;
      const add = (type, xFt, yFt, rot=0, label=null)=>{
        const d = defByType(type);
        p.items.push({ id: uid(), type, label: label || d.name, x:xFt*px, y:yFt*px, w:d.wFt*px, h:d.hFt*px, rot, locked:false, color:d.color });
      };
      add('stage', 28, 4);
      add('dj_booth', 32, 10);
      add('speaker_pair', 20, 10, 0, 'Speakers');
      add('dance_floor', 28, 18);
      add('photo_booth', 56, 8);
      add('bar', 50, 32);

      // rounds
      for (let r=0;r<2;r++){
        for (let c=0;c<4;c++) add('round_72', 8 + c*12, 30 + r*12);
      }

      // cocktail
      for (let i=0;i<6;i++) add('cocktail', 12 + i*6, 8);

      // moving heads (like lighting positions)
      for (let i=0;i<6;i++) add('moving_head', 6 + i*10, 2);

      loadProject(p);
      toast('Loaded demo mitzvah');
    }

    /* =========================================================
       EXPORT
       ========================================================= */

    function withExportMode(fn){
      document.body.classList.add('exporting');
      // lock help off
      UI.help.style.display = 'none';
      try{ fn(); }
      finally{
        document.body.classList.remove('exporting');
        UI.help.style.display = '';
      }
    }

    function drawExportFooter(ctx, w, h, scale){
      const pad = 24 * scale;
      const fontSize = 16 * scale;
      ctx.save();
      ctx.globalAlpha = 0.88;
      ctx.fillStyle = State.theme === 'dark' ? 'rgba(0,0,0,.55)' : 'rgba(255,255,255,.75)';
      const boxH = 54 * scale;
      ctx.fillRect(0, h - boxH, w, boxH);
      ctx.globalAlpha = 1;
      ctx.fillStyle = State.theme === 'dark' ? 'rgba(255,255,255,.92)' : 'rgba(17,24,39,.92)';
      ctx.font = `900 ${fontSize}px ${getComputedStyle(document.body).fontFamily}`;
      ctx.textBaseline = 'middle';
      const left = pad;
      const y = h - (boxH/2);
      const title = ExportBrand.site;
      ctx.fillText(title, left, y);

      ctx.font = `800 ${Math.round(fontSize*0.88)}px ${getComputedStyle(document.body).fontFamily}`;
      const meta = `${ExportBrand.tagline}  •  ${ExportBrand.email}`;
      const metaW = ctx.measureText(meta).width;
      ctx.fillText(meta, w - pad - metaW, y);
      ctx.restore();
    }

    async function exportPNG(){
      // Render room to canvas at high res
      const scale = 2; // hi-res
      const roomW = State.roomFt.w * State.pxPerFt;
      const roomH = State.roomFt.h * State.pxPerFt;
      const c = document.createElement('canvas');
      c.width = Math.round(roomW * scale);
      c.height = Math.round(roomH * scale);
      const ctx = c.getContext('2d');
      ctx.scale(scale, scale);

      // Background
      ctx.fillStyle = getComputedStyle(UI.viewport).backgroundColor || '#ffffff';
      ctx.fillRect(0,0,roomW,roomH);

      // bg image
      if (State.bg.src){
        await ensureImageLoaded(UI.bgImage);
        const iw = UI.bgImage.naturalWidth;
        const ih = UI.bgImage.naturalHeight;
        ctx.save();
        ctx.globalAlpha = 0.95;
        ctx.translate(State.bg.x, State.bg.y);
        ctx.scale(State.bg.scale, State.bg.scale);
        ctx.drawImage(UI.bgImage, 0, 0, iw, ih);
        ctx.restore();
      }

      // grid (optional)
      if (State.gridOn){
        const step = State.gridStepFt * State.pxPerFt;
        ctx.save();
        ctx.strokeStyle = State.theme==='dark' ? 'rgba(255,255,255,.06)' : 'rgba(17,24,39,.06)';
        ctx.lineWidth = 1;
        for (let x=0; x<=roomW; x+=step){
          ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,roomH); ctx.stroke();
        }
        for (let y=0; y<=roomH; y+=step){
          ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(roomW,y); ctx.stroke();
        }
        ctx.restore();
      }

      // room border
      ctx.save();
      ctx.strokeStyle = State.theme==='dark' ? 'rgba(255,255,255,.22)' : 'rgba(17,24,39,.25)';
      ctx.lineWidth = 2;
      roundRect(ctx, 0, 0, roomW, roomH, 14);
      ctx.stroke();
      ctx.restore();

      // items
      for (const it of State.items){
        drawItem(ctx, it);
      }

      // footer branding
      drawExportFooter(ctx, roomW, roomH, 1);

      const blob = await new Promise(res=>c.toBlob(res, 'image/png'));
      const name = safeFile(State.eventName || 'SleeveEvents_RoomPlan') || 'SleeveEvents_RoomPlan';
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${name}.png`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 800);
      toast('Exported PNG');
    }

    function roundRect(ctx, x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    async function ensureImageLoaded(img){
      if (!img || !img.src) return;
      if (img.complete && img.naturalWidth) return;
      await new Promise(res=>{ img.onload = ()=>res(); img.onerror=()=>res(); });
    }

    function drawItem(ctx, it){
      const d = defByType(it.type);
      const hex = colorHex(it.color || 'brand');
      ctx.save();
      // rotate around center
      const cx = it.x + it.w/2;
      const cy = it.y + it.h/2;
      ctx.translate(cx, cy);
      ctx.rotate((it.rot||0) * Math.PI/180);
      ctx.translate(-cx, -cy);

      // body
      ctx.fillStyle = hex;
      ctx.globalAlpha = State.theme==='dark' ? 0.28 : 0.16;
      if (d?.shape === 'circle'){
        ctx.beginPath();
        ctx.ellipse(cx, cy, it.w/2, it.h/2, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.globalAlpha = 0.85;
        ctx.strokeStyle = State.theme==='dark' ? 'rgba(255,255,255,.16)' : 'rgba(17,24,39,.16)';
        ctx.lineWidth = 1;
        ctx.stroke();
      } else {
        roundRect(ctx, it.x, it.y, it.w, it.h, 12);
        ctx.fill();
        ctx.globalAlpha = 0.85;
        ctx.strokeStyle = State.theme==='dark' ? 'rgba(255,255,255,.16)' : 'rgba(17,24,39,.16)';
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      // label
      ctx.globalAlpha = 1;
      ctx.fillStyle = State.theme==='dark' ? 'rgba(255,255,255,.92)' : 'rgba(17,24,39,.92)';
      ctx.font = `900 12px ${getComputedStyle(document.body).fontFamily}`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const label = it.label || d?.name || '';
      ctx.fillText(label, cx, cy);

      ctx.restore();
    }

    async function exportPDF(){
      // Lightweight: generate PNG then wrap in a printable page
      // NOTE: true PDF generation in vanilla JS without libs is limited; we use a print-to-PDF path.
      // This is stable and produces high quality.
      const scale = 2;
      const roomW = State.roomFt.w * State.pxPerFt;
      const roomH = State.roomFt.h * State.pxPerFt;
      const c = document.createElement('canvas');
      c.width = Math.round(roomW * scale);
      c.height = Math.round(roomH * scale);
      const ctx = c.getContext('2d');
      ctx.scale(scale, scale);

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,roomW,roomH);

      if (State.bg.src){
        await ensureImageLoaded(UI.bgImage);
        const iw = UI.bgImage.naturalWidth;
        const ih = UI.bgImage.naturalHeight;
        ctx.save();
        ctx.translate(State.bg.x, State.bg.y);
        ctx.scale(State.bg.scale, State.bg.scale);
        ctx.drawImage(UI.bgImage, 0, 0, iw, ih);
        ctx.restore();
      }

      if (State.gridOn){
        const step = State.gridStepFt * State.pxPerFt;
        ctx.save();
        ctx.strokeStyle = 'rgba(17,24,39,.06)';
        ctx.lineWidth = 1;
        for (let x=0; x<=roomW; x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,roomH); ctx.stroke(); }
        for (let y=0; y<=roomH; y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(roomW,y); ctx.stroke(); }
        ctx.restore();
      }

      ctx.save();
      ctx.strokeStyle = 'rgba(17,24,39,.25)';
      ctx.lineWidth = 2;
      roundRect(ctx, 0, 0, roomW, roomH, 14);
      ctx.stroke();
      ctx.restore();

      for (const it of State.items){
        drawItem(ctx, { ...it, color: it.color || 'brand' });
      }

      // footer
      drawExportFooter(ctx, roomW, roomH, 1);

      const dataUrl = c.toDataURL('image/png');
      const win = window.open('', '_blank');
      if (!win){
        alert('Popup blocked. Allow popups to export PDF.');
        return;
      }
      const title = (State.eventName || 'Sleeve Events Room Plan');
      win.document.write(`<!doctype html><html><head><title>${escapeHtml(title)}</title>
        <style>
          html,body{ margin:0; padding:0; background:#fff; }
          .wrap{ padding: 24px; }
          img{ width:100%; height:auto; display:block; }
          .meta{ font-family: ui-sans-serif, system-ui; color:#111827; margin: 0 0 10px; }
          @media print{ .wrap{ padding:0; } }
        </style>
      </head><body>
        <div class="wrap">
          <div class="meta"><b>${escapeHtml(title)}</b></div>
          <img src="${dataUrl}" />
        </div>
        <script>window.onload=()=>{ setTimeout(()=>{ window.print(); }, 250); }<\/script>
      </body></html>`);
      win.document.close();
      toast('Opened print dialog');
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>\"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    }

    /* =========================================================
       UI WIRING
       ========================================================= */
    function toggleTheme(){
      State.theme = (State.theme === 'dark') ? 'light' : 'dark';
      applyTheme();
      renderItems();
      renderGrid();
      toast(State.theme === 'dark' ? 'Dark mode' : 'Light mode');
    }

    function toggleGrid(){
      State.gridOn = !State.gridOn;
      renderGrid();
      toast(State.gridOn ? 'Grid on' : 'Grid off');
    }

    function toggleSnap(){
      State.snapOn = !State.snapOn;
      renderGrid();
      toast(State.snapOn ? 'Snap on' : 'Snap off');
    }

    function openSheet(){
      UI.sheetBackdrop.style.display = 'block';
      UI.sheet.style.display = 'block';
    }

    function closeSheet(){
      UI.sheetBackdrop.style.display = 'none';
      UI.sheet.style.display = 'none';
    }

    UI.btnSheetClose.addEventListener('click', closeSheet);
    UI.sheetBackdrop.addEventListener('click', closeSheet);

    UI.btnTools.addEventListener('click', openSheet);
    UI.fab.addEventListener('click', openSheet);

    UI.toggleTheme.addEventListener('click', toggleTheme);
    UI.toggleGrid.addEventListener('click', toggleGrid);
    UI.toggleSnap.addEventListener('click', toggleSnap);

    UI.btnHelpHide.addEventListener('click', ()=>{ UI.help.style.display='none'; toast('Help hidden'); });

    // Project bindings
    UI.eventName.addEventListener('input', ()=>{ State.eventName = UI.eventName.value; });
    UI.eventNotes.addEventListener('input', ()=>{ State.eventNotes = UI.eventNotes.value; });
    UI.gridStep.addEventListener('change', ()=>{
      State.gridStepFt = parseFloat(UI.gridStep.value)||2;
      State.snapStepFt = State.gridStepFt;
      renderGrid();
      toast(`Grid ${State.gridStepFt}ft`);
    });

    UI.btnApplyRoom.addEventListener('click', ()=>{ applyRoom(); toast('Room updated'); });

    UI.btnFit.addEventListener('click', ()=>fitToView());

    function fitToView(){
      const roomW = State.roomFt.w * State.pxPerFt;
      const roomH = State.roomFt.h * State.pxPerFt;
      const rect = UI.viewport.getBoundingClientRect();
      const pad = 24;
      const zx = (rect.width - pad*2) / roomW;
      const zy = (rect.height - pad*2) / roomH;
      State.view.zoom = clamp(Math.min(zx, zy), 0.25, 3);
      // center
      State.view.panX = rect.width/2 - (roomW*State.view.zoom)/2;
      State.view.panY = rect.height/2 - (roomH*State.view.zoom)/2;
      applyView();
      toast('Fit view');
    }

    UI.btnSetScale.addEventListener('click', ()=>{
      State.scaleTool.step = 0;
      State.scaleTool.p1 = null;
      State.scaleTool.p2 = null;
      setMode('setScale');
      toast('Scale: click first point');
    });

    UI.btnClear.addEventListener('click', ()=>{
      if (!confirm('Clear all items?')) return;
      State.items = [];
      clearSelection();
      renderItems();
      updateGear();
      toast('Cleared');
    });

    // background
    UI.btnBgUpload.addEventListener('click', ()=>UI.bgUpload.click());
    UI.btnBgFit.addEventListener('click', ()=>bgFit());

    UI.chipBgLock.addEventListener('click', ()=>{ State.bg.locked = !State.bg.locked; renderBg(); toast(State.bg.locked ? 'BG locked' : 'BG unlocked'); });
    UI.chipShowGrid.addEventListener('click', toggleGrid);
    UI.chipSnap.addEventListener('click', toggleSnap);

    // saving/export
    UI.btnSaveLocal.addEventListener('click', saveLocal);
    UI.btnLoadLocal.addEventListener('click', loadLocal);
    UI.btnDownload.addEventListener('click', downloadProject);
    UI.btnUpload.addEventListener('click', uploadProject);
    UI.btnShare.addEventListener('click', copyShareLink);
    UI.btnExportPNG.addEventListener('click', exportPNG);
    UI.btnExportPDF.addEventListener('click', exportPDF);

    // selected actions
    UI.selLabel.addEventListener('input', ()=>{
      const ids = [...State.selected];
      if (ids.length !== 1) return;
      const it = getItem(ids[0]);
      it.label = UI.selLabel.value;
      renderItems();
    });

    UI.chipLock.addEventListener('click', toggleLockSelected);
    UI.chipDuplicate.addEventListener('click', duplicateSelected);
    UI.chipDelete.addEventListener('click', deleteSelected);

    UI.chipAlignL.addEventListener('click', ()=>alignSelected('L'));
    UI.chipAlignC.addEventListener('click', ()=>alignSelected('C'));
    UI.chipAlignR.addEventListener('click', ()=>alignSelected('R'));
    UI.chipDistH.addEventListener('click', distributeSelected);

    // mobile controls
    UI.mSetScale.addEventListener('click', ()=>{ closeSheet(); UI.btnSetScale.click(); });
    UI.mFit.addEventListener('click', ()=>{ closeSheet(); fitToView(); });
    UI.mBgUpload.addEventListener('click', ()=>{ closeSheet(); UI.btnBgUpload.click(); });
    UI.mBgFit.addEventListener('click', ()=>{ closeSheet(); bgFit(); });
    UI.mDemoWedding.addEventListener('click', ()=>{ closeSheet(); demoWedding(); });
    UI.mDemoMitzvah.addEventListener('click', ()=>{ closeSheet(); demoMitzvah(); });
    UI.mToggleTheme.addEventListener('click', ()=>{ toggleTheme(); });
    UI.mToggleGrid.addEventListener('click', ()=>{ toggleGrid(); });
    UI.mToggleSnap.addEventListener('click', ()=>{ toggleSnap(); });
    UI.mExportPNG.addEventListener('click', ()=>{ closeSheet(); exportPNG(); });
    UI.mExportPDF.addEventListener('click', ()=>{ closeSheet(); exportPDF(); });
    UI.mShare.addEventListener('click', ()=>{ copyShareLink(); });
    UI.mDownload.addEventListener('click', ()=>{ downloadProject(); });
    UI.mSaveLocal.addEventListener('click', ()=>{ saveLocal(); });
    UI.mLoadLocal.addEventListener('click', ()=>{ loadLocal(); });
    UI.mUpload.addEventListener('click', ()=>{ uploadProject(); });
    UI.mClear.addEventListener('click', ()=>{ UI.btnClear.click(); });

    // Extra: demo in desktop via Tools button (simple)
    UI.btnTools.addEventListener('dblclick', ()=>demoWedding());

    // sheet triggers
    UI.fab.addEventListener('click', openSheet);

    // background panning when unlocked
    UI.viewport.addEventListener('pointerdown', (e)=>{
      if (State.bg.src && !State.bg.locked && !e.target.closest('.item') && !isPanKey() && State.mode==='idle'){
        // start bg drag
        setMode('dragging');
        State.pointer.id = e.pointerId;
        PointerCapture.safeCapture(UI.viewport, e.pointerId);
        const p = screenToRoomPoint(e.clientX, e.clientY);
        State.drag = {
          kind:'bg',
          start:{x:p.x,y:p.y},
          orig:{x:State.bg.x, y:State.bg.y}
        };
      }
    });

    UI.viewport.addEventListener('pointermove', (e)=>{
      if (State.pointer.id !== e.pointerId) return;
      if (State.drag && State.drag.kind==='bg'){
        const p = screenToRoomPoint(e.clientX, e.clientY);
        const dx = p.x - State.drag.start.x;
        const dy = p.y - State.drag.start.y;
        State.bg.x = State.drag.orig.x + dx;
        State.bg.y = State.drag.orig.y + dy;
        renderBg();
      }
    });

    UI.viewport.addEventListener('pointerup', (e)=>{
      if (State.drag && State.drag.kind==='bg'){
        State.drag = null;
        setMode('idle');
      }
    });

    /* =========================================================
       TESTS (optional)
       ========================================================= */
    function runTests(){
      const assert = (cond, msg) => { if (!cond) throw new Error('Test failed: ' + msg); };
      assert(normalizeAngle(0) === 0, 'normalizeAngle 0');
      assert(normalizeAngle(360) === 0, 'normalizeAngle 360');
      assert(normalizeAngle(-10) === 350, 'normalizeAngle -10');
      assert(safeFile('Hello World!') === 'Hello_World_', 'safeFile basic');
      assert(safeFile('') === '', 'safeFile empty');
      const prevSnap = State.snapOn;
      const prevScale = State.pxPerFt;
      State.snapOn = false; State.pxPerFt = 40;
      assert(snapPx(53) === 53, 'snapPx off');
      State.snapOn = true; State.snapStepFt = 1;
      assert(snapPx(53) === 40, 'snapPx on rounds');
      State.snapOn = prevSnap; State.pxPerFt = prevScale;
      assert(PointerCapture.safeCapture(null, 1) === false, 'PointerCapture null el');
      assert(PointerCapture.safeCapture(document.createElement('div'), 1) === false, 'PointerCapture disconnected el');
      console.log('[Sleeve Planner] Tests OK');
    }

    /* =========================================================
       INIT
       ========================================================= */
    function init(){
      // palette
      buildPalette();

      // load from URL if present
      const fromUrl = decodeProjectFromURL();
      if (fromUrl){
        loadProject(fromUrl);
        // clear hash to avoid reloading unexpectedly
        history.replaceState(null, '', location.pathname + location.search);
      } else {
        // defaults
        State.eventName = UI.eventName.value;
        State.eventNotes = UI.eventNotes.value;
        State.gridStepFt = parseFloat(UI.gridStep.value)||2;
        State.snapStepFt = State.gridStepFt;
        applyTheme();
        applyRoom();
        applyView();
        fitToView();
        renderItems();
        renderBg();
        renderGrid();
        updateGear();
        updateScaleNote();
      }

      // responsive: show help on desktop
      if (window.innerWidth <= 560){
        UI.help.style.display = 'none';
      }

      // iOS: prevent page scroll while using the planner
      document.addEventListener('touchmove', (e)=>{
        if (e.target.closest && e.target.closest('#viewport')) e.preventDefault();
      }, { passive:false });

      // tools click on mobile
      UI.btnTools.addEventListener('click', ()=>{
        if (window.innerWidth <= 560) openSheet();
      });

      // demo shortcuts in sheet already

      // Debug tests
      if (location.search.includes('test=1')){
        try{ runTests(); } catch(err){ console.error(err); alert(err.message); }
      }
    }

    init();
  </script>
</body>
</html>
